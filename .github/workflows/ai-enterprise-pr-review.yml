name: AI PR Review
'on':
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
permissions:
  contents: write
  pull-requests: write
env:
  REVIEW_PATHS: src/**/*.cs
  MODEL_OPENAI: gpt-4.1
  MODEL_DEEPSEEK: deepseek-chat
jobs:
  ai_review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Get PR diff
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const diff = pr.data.diff_url
            const response = await fetch(diff);
            const text = await response.text();
            core.setOutput("diff", text);
      - name: Build JSON request
        id: build_json
        run: |
          cat << 'EOF' > request.json
          {
            "model": "${MODEL_OPENAI}",
            "max_tokens": 1500,
            "temperature": 0.2,
            "messages": [
              {
                "role": "system",
                "content": "You are a senior .NET reviewer. Output issues as bullet points with Severity: High/Medium/Low. Mark blockers clearly."
              },
              {
                "role": "user",
                "content": "Review this diff:\n\n${DIFF}"
              }
            ]
          }
          EOF
      - name: Run OpenAI Review
        id: ai
        env:
          OPENAI_API_KEY: '${{ secrets.OPENAI_API_KEY }}'
          DIFF: '${{ steps.diff.outputs.diff }}'
        run: >
          response=$(curl -s -X POST
          "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @request.json)

          echo "$response" > full_response.json

          review=$(echo "$response" | jq -r '.choices[0].message.content')

          echo "$review"

          echo "review_output<<EOF" >> $GITHUB_OUTPUT

          echo "$review" >> $GITHUB_OUTPUT

          echo "EOF" >> $GITHUB_OUTPUT
      - name: Post sticky comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: "## \U0001F916 AI Code Review (OpenAI + DeepSeek)\n${{ steps.ai.outputs.review_output }}\n"
      - name: Fail PR on High severity
        if: 'contains(steps.ai.outputs.review_output, ''High'')'
        run: |
          echo "High severity issues found â€” blocking merge."
          exit 1
      - name: Auto-merge (if allowed)
        if: >-
          github.event.pull_request.mergeable == true &&
          !contains(steps.ai.outputs.review_output, 'High')
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
